---
title: "cptacBench"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{cptacBench}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction
CPTAC benchmark does this and that.

# Getting set up
```{r setup}
library(benchmarkeR)
```

We then take a look at the tutorialData inside PHONEMeS. It consists of a top 
table results object from limma coming from phosphoproteomics. This contains the 
information about phosphorylation sites that are differntially abundant between 
two conditions. 

# Load cptac
```{r}
cptac_list <- purrr::map(unique(cptacData$cancer), function(cancer_type){
  cptacData %>%
    dplyr::filter(cancer == cancer_type) %>%
    tidyr::pivot_wider(names_from = "sample", values_from = "statistic", values_fill = NA) %>%
    dplyr::select(-cancer) %>%
    tibble::column_to_rownames("id")
})

names(cptac_list) <- unique(cptacData$cancer)
head(cptac_list)
```

# Activity estimation
You can now use the matrix to infer kinase activities. Make sure to use HGNC symbols for the kinase names as the meta data.
Here you can use your own method and prior to infer kinase activities. Here we run an example using the z-score as implemented by RoKAI
and PhosphoSitePlus.

```{r}
head(phosphositeplus)
```

```{r}
pps_id <- cptacData$id %>% 
  unique()
map_pps <- data.frame(pps_id = pps_id) %>%
  dplyr::mutate(ENSEMBL = map_chr(str_split(pps_id, "\\|"), 1)) %>%
  dplyr::mutate(ENSEMBL = map_chr(str_split(ENSEMBL, "\\."), 1))  %>%
  dplyr::mutate(sequence = map_chr(str_split(pps_id, "\\|"), 4))
```
```{r}
mapped_phosphositeplus <- phosphositeplus %>%
  dplyr::left_join(map_pps, by = c("ENSEMBL", "sequence"), relationship = "many-to-many") %>%
  dplyr::mutate(target = pps_id) %>%
  dplyr::filter(!is.na(pps_id)) %>%
  dplyr::select(source, target, mor) %>%
  dplyr::distinct()
```

Run activity scores
```{r}
act_scores <- purrr::map(cptac_list, ~list(zscore_ppsp = run_zscore(mat = .x, network = mapped_phosphositeplus)))

head(act_scores)
```
# Perturbation benchmark
```{r}
str(cptacGS$BRCA$GS_pos_pairs)
```

```{r}
performance <- benchmarkROC(score_lists = act_scores, GS_list = cptacGS)
```

Plot results
```{r}
auroc_p <- performance %>%
  ggplot2::ggplot(ggplot2::aes(x=method, y=auroc)) +
  ggplot2::geom_boxplot(outlier.size=1, lwd=0.6) +
  ggplot2::geom_hline(yintercept = 0.5)

auroc_p
```
